---
layout: post
title: Binary Attachments In WCF With MTOM
categories:
- .NET
- Microsoft
tags:
- .Net
- MTOM
- WCF
- Web Services
status: publish
type: post
published: true
meta:
  _wpas_done_all: '1'
  views: '12950'
  _edit_last: '1'
  _wp_rp_extracted_image_url: http://www.debugrelease.com/wp-content/uploads/2013/04/image30-150x150.jpg
  _wp_rp_extracted_image_url_full: http://www.debugrelease.com/wp-content/uploads/2013/04/image30.png
  wpzoom_is_featured: ''
  wpzoom_is_carousel: ''
  wpzoom_show_media: ''
  wpzoom_post_template: ''
  wpzoom_post_embed_code: ''
  simplecatch-sidebarlayout: ''
---
<p>MTOM which stands for Message Transmission Optimization Mechanism is a <a href="http://www.w3.org/TR/soap12-mtom/">W3C Recommendation</a> which is mostly about reducing the size of binary data when transferred through SOAP web services.</p> <p>Binary data can be sent through SOAP already. So what’s the need for MTOM? Well it turns out that binary data in SOAP messages is encoded as text by applying Base64 encoding. This increases the size of payload. MTOM recommends that binary data should be sent in its original form without applying any encoding. This is a good idea and can work well when transferring files via web services.</p> <h4>Service</h4> <p>I wanted to try it out in WCF which supports MTOM. So I built myself a service which gets a photo from local drive and provides an operation which can transfer the file to client. Below is the simple service contract I came up with.</p>

<pre class="lang:c# decode:true " >
[ServiceContract]
public interface IPhotoService
{ 
  [OperationContract] 
  PhotoServiceResponse GetPhoto();
}
</pre>

<p><br>GetPhoto operation returns a PhotoServiceResponse which is defined below.<br></p>

<pre class="lang:c# decode:true " >
[MessageContract]
public class PhotoServiceResponse
{ 
  [MessageBodyMember] 
  public Byte[] Photo { get; set; }
}
</pre>

<p>PhotoServiceResponse is a <strong>MessgeContract</strong> which has a member decorated as <strong>MessageBodyMember</strong>. This is absolutely required. Creating DataMembers as you would to describe the data to be included with a message will not work. So remember that for MTOM you must define a <strong>MessageContract</strong> which should have a <strong>MessageBodyMember</strong>.</p>
<p>The implementation of this service is simple.</p>

<pre class="lang:c# decode:true " >
public class PhotoService : IPhotoService
{ 
  public PhotoServiceResponse GetPhoto() 
  { 
    PhotoServiceResponse response = new PhotoServiceResponse(); 
    response.Photo = File.ReadAllBytes(@"c:tempqueenstown.jpg"); 
    return response; 
  }
}
</pre>

<p><br>For the config file for service I added a <strong>wsHttpBinding</strong> and specified <strong>messgeEncoding</strong> to be <strong>Mtom</strong>.<br></p>

 
<pre class="lang:xhtml decode:true " >&lt;wsHttpBinding&gt;
  &lt;binding name="WsHttpMtomBinding" messageEncoding="Mtom" /&gt;
&lt;/wsHttpBinding&gt;</pre> 


<p><br>And the end point used the binding configuration.<br></p>

 
<pre class="lang:xhtml decode:true " >&lt;service name="WcfMTOMSample.PhotoService"&gt;
  &lt;endpoint binding="wsHttpBinding"
   bindingConfiguration="WsHttpMtomBinding"
    contract="WcfMTOMSample.IPhotoService" /&gt;
&lt;/service&gt;</pre> 


<h4>Client</h4>
<p>I created a Windows Forms client to render out the photo I’d receive from my service. GetPhoto opreation is called like any other service operation. A byte array is passed to GetPhoto method as a out parameter.</p>

<pre class="lang:c# decode:true " >
PhotoServiceClient client = new PhotoServiceClient();
byte[] photoBytes;client.GetPhoto(out photoBytes);
</pre>

<p><br>Within the client config I created a <strong>wsHttpBinding</strong> and specified <strong>messgeEncoding</strong> as <strong>Mtom</strong>. I also specified good enough size to accommodate approx 2.5 mb data by setting a large value for <strong>maxReceivedMessageSize</strong>. Within <strong>readerQuotas</strong> setting the <strong>maxArrayLength</strong> attribute takes care of large arrays.<br></p>
 
<pre class="lang:xhtml decode:true " >&lt;wsHttpBinding&gt;
  &lt;binding name="IPhotoServiceBinding"
   maxReceivedMessageSize="2621440"
    messageEncoding="Mtom"&gt;
    &lt;readerQuotas maxArrayLength="2621440"/&gt;
  &lt;/binding&gt;
&lt;/wsHttpBinding&gt;</pre> 

<p><br>The client then used the binding configuration.<br></p>
 
<pre class="lang:xhtml decode:true " >&lt;client&gt;
  &lt;endpoint address="http://localhost:1669/PhotoService.svc"
   binding="wsHttpBinding"
    bindingConfiguration="IPhotoServiceBinding"
    contract="PhotoServiceReference.IPhotoService"&gt;
  &lt;/endpoint&gt;
&lt;/client&gt;</pre> 

<p>And finally I had my service return me a photo as binary data which I displayed on a form.</p>
<p><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.debugrelease.com/wp-content/uploads/2010/11/image30.png" width="400" height="354"></p>
<p>BTW: This photo is from my recent trip to Queenstown in New Zealand. A country I absolutely love and would visit again many times.</p>
<p>I hope you enjoyed the post.</p>
