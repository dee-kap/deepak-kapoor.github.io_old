---
layout: post
title: Remove Duplicate Lines From A Text File Using LINQ
categories:
- .NET
- Microsoft
tags:
- LINQ
status: publish
type: post
published: true
meta:
  _wpas_done_all: '1'
  views: '11322'
  _edit_last: '1'
  _wp_rp_extracted_image_url: ''
  _wp_rp_extracted_image_url_full: ''
  wpzoom_is_featured: ''
  wpzoom_is_carousel: ''
  wpzoom_show_media: ''
  wpzoom_post_template: ''
  wpzoom_post_embed_code: ''
  simplecatch-sidebarlayout: ''
---
<p>A question was posted on c-sharpcorner forums asking how you would <a href="http://www.c-sharpcorner.com/Forums/ShowMessages.aspx?ThreadID=51446">remove duplicate lines from a text file</a>. It got me thinking about how this problem could be addressed using LINQ. Before I get into the solution, here is the problem statement. </p>  <h4>The problem</h4>  <blockquote>   <p>I am trying to remove duplicate lines from a text file. To make things difficult the lines contain non unique timestamps but a unique reference number. Some of the duplicates amount to 10 lines whereas others can only be 2 lines.</p>    <p>     <br />1. Here are some examples of duplicates lines:&lt;timestamp&gt;,&lt;reference&gt;,&lt;error message&gt;       <br />08:47:22,95847170050,Problem inputting data.       <br />08:48:28,96672540040,More problems inputting data.       <br />08:49:29,95847170050,Problem inputting data.       <br />08:55:28,106622510040,Extra issues inputting data.       <br />08:56:35,95847170050,Problem inputting data.       <br />08:57:35,106622510040,Extra issues inputting data.       <br />09:02:35,96672540040,More problems inputting data.       <br />09:03:41,96672540040,More problems inputting data.       <br />09:04:41,106622510040,Extra issues inputting data.       <br /></p>   <b></b>    <p><b>I want to delete all but KEEP the most recent duplicate line.</b></p> </blockquote>  <p>On the forum there is also some Java code which has been used as a solution. But I will ignore it so that I can approach it from a fresh perspective.</p>  <p>&#160;</p>  <h4>Solution The LINQ Way</h4>  <p>Here is my approach to remove duplicate lines from a text file. Firstly, I read the contents of the file into a collection of Type List&lt;Error&gt; using an approach <a href="http://www.debugrelease.com/tutorial-reading-a-text-file-using-linq/">I described in an earlier post</a> .</p>  

<pre class="lang:c# decode:true " >
var query = from e in
  (from line in File.ReadAllLines(originalFile)
    let errorRecord = line.Split(',')
    let timestamp = errorRecord[0].Split(':')
    select new Error() 
    {                           
      TimeStamp = new TimeSpan(
        Convert.ToInt32(timestamp[0]), 
        Convert.ToInt32(timestamp[1]), 
        Convert.ToInt32(timestamp[2])),
      Reference = errorRecord[1],
      Message = errorRecord[2]
    })
  select e;
</pre>

<p>This is what my Error class looks like. This class maps to a record in the file.</p>

<pre class="lang:c# decode:true " >
public class Error
{
  public TimeSpan TimeStamp { get; set; }
  public string Reference { get; set; }
  public string Message { get; set; }
}
</pre>

<p>Once I have the collection loaded up from the file. I then use a LINQ query to select the results I want. This query uses combination of group by and aggregates to select the most current record for a reference number as per the original problem statement.</p>

<pre class="lang:c# decode:true " >
var query = from e in errorCollection
  group e by new { e.Reference, e.Message } into g
  let MaxDate = g.Max(x => x.TimeStamp)
  select new Error 
  {
    TimeStamp = MaxDate,
    Reference = g.Key.Reference, 
    Message = g.Key.Message
  };
</pre>

<p>Finally I write the collection I get from the query above to another text file.</p>

<pre class="lang:c# decode:true " >
List<Error> newList = query.ToList();

using (StreamWriter sw = new StreamWriter(processedFile))
{
  newList.ForEach(x => sw.WriteLine(x.TimeStamp+","+x.Reference+","+x.Message));
  sw.Close();
}
</pre>

<p>The code which loads the collection from the file can be optimized for performance but it does a good job when dealing with a reasonably small file. Below is the full code for my two methods.</p>

<pre class="lang:c# decode:true " >
public void RemoveDuplicates(string originalFile, string processedFile)
{
  List<Error> errorCollection = ReadFileIntoCollection(originalFile);
            
  var query = from e in errorCollection
    group e by new { e.Reference, e.Message } into g
    let MaxDate = g.Max(x => x.TimeStamp)
    select new Error 
    {
      TimeStamp = MaxDate,
      Reference = g.Key.Reference, 
      Message = g.Key.Message
    };

  List<Error> newList = query.ToList();

  using (StreamWriter sw = new StreamWriter(processedFile))
  {
    newList.ForEach(x => sw.WriteLine(x.TimeStamp+","+x.Reference+","+x.Message));
    sw.Close();
  }
}

public List<Error> ReadFileIntoCollection(string originalFile)
{
  List<Error> errorCollection = null;

  var query = from e in
    (from line in File.ReadAllLines(originalFile)
    let errorRecord = line.Split(',')
    let timestamp = errorRecord[0].Split(':')
    select new Error() 
    {
      TimeStamp = new TimeSpan(
        Convert.ToInt32(timestamp[0]), 
        Convert.ToInt32(timestamp[1]), 
        Convert.ToInt32(timestamp[2])),
      Reference = errorRecord[1],
      Message = errorRecord[2]
    })
    select e;

  errorCollection = query.ToList<Error>();
  return errorCollection;
}
</pre>

<p>So this is my approach to remove duplicates from a text file using LINQ. This is just one example of how LINQ can be used to create creative solutions to some common programming problem. The power of LINQ lies in its simplicity which you can use to write beautiful code. </p>
